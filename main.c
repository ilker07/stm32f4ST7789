
#include "stm32f4xx.h"                  // Device header


uint32_t sayi=0;




typedef struct {
    const uint8_t width;
    uint8_t height;
    const uint16_t *data;
} FontDef;

typedef uint8_t benim;

static const uint16_t Font7x10 [] = {
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,  // sp
0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x0000, 0x1000, 0x0000, 0x0000,  // !
0x2800, 0x2800, 0x2800, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,  // "
0x2400, 0x2400, 0x7C00, 0x2400, 0x4800, 0x7C00, 0x4800, 0x4800, 0x0000, 0x0000,  // #
0x3800, 0x5400, 0x5000, 0x3800, 0x1400, 0x5400, 0x5400, 0x3800, 0x1000, 0x0000,  // $
0x2000, 0x5400, 0x5800, 0x3000, 0x2800, 0x5400, 0x1400, 0x0800, 0x0000, 0x0000,  // %
0x1000, 0x2800, 0x2800, 0x1000, 0x3400, 0x4800, 0x4800, 0x3400, 0x0000, 0x0000,  // &
0x1000, 0x1000, 0x1000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,  // '
0x0800, 0x1000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x1000, 0x0800,  // (
0x2000, 0x1000, 0x0800, 0x0800, 0x0800, 0x0800, 0x0800, 0x0800, 0x1000, 0x2000,  // )
0x1000, 0x3800, 0x1000, 0x2800, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,  // *
0x0000, 0x0000, 0x1000, 0x1000, 0x7C00, 0x1000, 0x1000, 0x0000, 0x0000, 0x0000,  // +
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x1000, 0x1000, 0x1000,  // ,
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x3800, 0x0000, 0x0000, 0x0000, 0x0000,  // -
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x1000, 0x0000, 0x0000,  // .
0x0800, 0x0800, 0x1000, 0x1000, 0x1000, 0x1000, 0x2000, 0x2000, 0x0000, 0x0000,  // /
0x3800, 0x4400, 0x4400, 0x5400, 0x4400, 0x4400, 0x4400, 0x3800, 0x0000, 0x0000,  // 0
0x1000, 0x3000, 0x5000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x0000, 0x0000,  // 1
0x3800, 0x4400, 0x4400, 0x0400, 0x0800, 0x1000, 0x2000, 0x7C00, 0x0000, 0x0000,  // 2
0x3800, 0x4400, 0x0400, 0x1800, 0x0400, 0x0400, 0x4400, 0x3800, 0x0000, 0x0000,  // 3
0x0800, 0x1800, 0x2800, 0x2800, 0x4800, 0x7C00, 0x0800, 0x0800, 0x0000, 0x0000,  // 4
0x7C00, 0x4000, 0x4000, 0x7800, 0x0400, 0x0400, 0x4400, 0x3800, 0x0000, 0x0000,  // 5
0x3800, 0x4400, 0x4000, 0x7800, 0x4400, 0x4400, 0x4400, 0x3800, 0x0000, 0x0000,  // 6
0x7C00, 0x0400, 0x0800, 0x1000, 0x1000, 0x2000, 0x2000, 0x2000, 0x0000, 0x0000,  // 7
0x3800, 0x4400, 0x4400, 0x3800, 0x4400, 0x4400, 0x4400, 0x3800, 0x0000, 0x0000,  // 8
0x3800, 0x4400, 0x4400, 0x4400, 0x3C00, 0x0400, 0x4400, 0x3800, 0x0000, 0x0000,  // 9
0x0000, 0x0000, 0x1000, 0x0000, 0x0000, 0x0000, 0x0000, 0x1000, 0x0000, 0x0000,  // :
0x0000, 0x0000, 0x0000, 0x1000, 0x0000, 0x0000, 0x0000, 0x1000, 0x1000, 0x1000,  // ;
0x0000, 0x0000, 0x0C00, 0x3000, 0x4000, 0x3000, 0x0C00, 0x0000, 0x0000, 0x0000,  // <
0x0000, 0x0000, 0x0000, 0x7C00, 0x0000, 0x7C00, 0x0000, 0x0000, 0x0000, 0x0000,  // =
0x0000, 0x0000, 0x6000, 0x1800, 0x0400, 0x1800, 0x6000, 0x0000, 0x0000, 0x0000,  // >
0x3800, 0x4400, 0x0400, 0x0800, 0x1000, 0x1000, 0x0000, 0x1000, 0x0000, 0x0000,  // ?
0x3800, 0x4400, 0x4C00, 0x5400, 0x5C00, 0x4000, 0x4000, 0x3800, 0x0000, 0x0000,  // @
0x1000, 0x2800, 0x2800, 0x2800, 0x2800, 0x7C00, 0x4400, 0x4400, 0x0000, 0x0000,  // A
0x7800, 0x4400, 0x4400, 0x7800, 0x4400, 0x4400, 0x4400, 0x7800, 0x0000, 0x0000,  // B
0x3800, 0x4400, 0x4000, 0x4000, 0x4000, 0x4000, 0x4400, 0x3800, 0x0000, 0x0000,  // C
0x7000, 0x4800, 0x4400, 0x4400, 0x4400, 0x4400, 0x4800, 0x7000, 0x0000, 0x0000,  // D
0x7C00, 0x4000, 0x4000, 0x7C00, 0x4000, 0x4000, 0x4000, 0x7C00, 0x0000, 0x0000,  // E
0x7C00, 0x4000, 0x4000, 0x7800, 0x4000, 0x4000, 0x4000, 0x4000, 0x0000, 0x0000,  // F
0x3800, 0x4400, 0x4000, 0x4000, 0x5C00, 0x4400, 0x4400, 0x3800, 0x0000, 0x0000,  // G
0x4400, 0x4400, 0x4400, 0x7C00, 0x4400, 0x4400, 0x4400, 0x4400, 0x0000, 0x0000,  // H
0x3800, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x3800, 0x0000, 0x0000,  // I
0x0400, 0x0400, 0x0400, 0x0400, 0x0400, 0x0400, 0x4400, 0x3800, 0x0000, 0x0000,  // J
0x4400, 0x4800, 0x5000, 0x6000, 0x5000, 0x4800, 0x4800, 0x4400, 0x0000, 0x0000,  // K
0x4000, 0x4000, 0x4000, 0x4000, 0x4000, 0x4000, 0x4000, 0x7C00, 0x0000, 0x0000,  // L
0x4400, 0x6C00, 0x6C00, 0x5400, 0x4400, 0x4400, 0x4400, 0x4400, 0x0000, 0x0000,  // M
0x4400, 0x6400, 0x6400, 0x5400, 0x5400, 0x4C00, 0x4C00, 0x4400, 0x0000, 0x0000,  // N
0x3800, 0x4400, 0x4400, 0x4400, 0x4400, 0x4400, 0x4400, 0x3800, 0x0000, 0x0000,  // O
0x7800, 0x4400, 0x4400, 0x4400, 0x7800, 0x4000, 0x4000, 0x4000, 0x0000, 0x0000,  // P
0x3800, 0x4400, 0x4400, 0x4400, 0x4400, 0x4400, 0x5400, 0x3800, 0x0400, 0x0000,  // Q
0x7800, 0x4400, 0x4400, 0x4400, 0x7800, 0x4800, 0x4800, 0x4400, 0x0000, 0x0000,  // R
0x3800, 0x4400, 0x4000, 0x3000, 0x0800, 0x0400, 0x4400, 0x3800, 0x0000, 0x0000,  // S
0x7C00, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x0000, 0x0000,  // T
0x4400, 0x4400, 0x4400, 0x4400, 0x4400, 0x4400, 0x4400, 0x3800, 0x0000, 0x0000,  // U
0x4400, 0x4400, 0x4400, 0x2800, 0x2800, 0x2800, 0x1000, 0x1000, 0x0000, 0x0000,  // V
0x4400, 0x4400, 0x5400, 0x5400, 0x5400, 0x6C00, 0x2800, 0x2800, 0x0000, 0x0000,  // W
0x4400, 0x2800, 0x2800, 0x1000, 0x1000, 0x2800, 0x2800, 0x4400, 0x0000, 0x0000,  // X
0x4400, 0x4400, 0x2800, 0x2800, 0x1000, 0x1000, 0x1000, 0x1000, 0x0000, 0x0000,  // Y
0x7C00, 0x0400, 0x0800, 0x1000, 0x1000, 0x2000, 0x4000, 0x7C00, 0x0000, 0x0000,  // Z
0x1800, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1800,  // [
0x2000, 0x2000, 0x1000, 0x1000, 0x1000, 0x1000, 0x0800, 0x0800, 0x0000, 0x0000,  /* \ */
0x3000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x3000,  // ]
0x1000, 0x2800, 0x2800, 0x4400, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,  // ^
0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xFE00,  // _
0x2000, 0x1000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,  // `
0x0000, 0x0000, 0x3800, 0x4400, 0x3C00, 0x4400, 0x4C00, 0x3400, 0x0000, 0x0000,  // a
0x4000, 0x4000, 0x5800, 0x6400, 0x4400, 0x4400, 0x6400, 0x5800, 0x0000, 0x0000,  // b
0x0000, 0x0000, 0x3800, 0x4400, 0x4000, 0x4000, 0x4400, 0x3800, 0x0000, 0x0000,  // c
0x0400, 0x0400, 0x3400, 0x4C00, 0x4400, 0x4400, 0x4C00, 0x3400, 0x0000, 0x0000,  // d
0x0000, 0x0000, 0x3800, 0x4400, 0x7C00, 0x4000, 0x4400, 0x3800, 0x0000, 0x0000,  // e
0x0C00, 0x1000, 0x7C00, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x0000, 0x0000,  // f
0x0000, 0x0000, 0x3400, 0x4C00, 0x4400, 0x4400, 0x4C00, 0x3400, 0x0400, 0x7800,  // g
0x4000, 0x4000, 0x5800, 0x6400, 0x4400, 0x4400, 0x4400, 0x4400, 0x0000, 0x0000,  // h
0x1000, 0x0000, 0x7000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x0000, 0x0000,  // i
0x1000, 0x0000, 0x7000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0xE000,  // j
0x4000, 0x4000, 0x4800, 0x5000, 0x6000, 0x5000, 0x4800, 0x4400, 0x0000, 0x0000,  // k
0x7000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x0000, 0x0000,  // l
0x0000, 0x0000, 0x7800, 0x5400, 0x5400, 0x5400, 0x5400, 0x5400, 0x0000, 0x0000,  // m
0x0000, 0x0000, 0x5800, 0x6400, 0x4400, 0x4400, 0x4400, 0x4400, 0x0000, 0x0000,  // n
0x0000, 0x0000, 0x3800, 0x4400, 0x4400, 0x4400, 0x4400, 0x3800, 0x0000, 0x0000,  // o
0x0000, 0x0000, 0x5800, 0x6400, 0x4400, 0x4400, 0x6400, 0x5800, 0x4000, 0x4000,  // p
0x0000, 0x0000, 0x3400, 0x4C00, 0x4400, 0x4400, 0x4C00, 0x3400, 0x0400, 0x0400,  // q
0x0000, 0x0000, 0x5800, 0x6400, 0x4000, 0x4000, 0x4000, 0x4000, 0x0000, 0x0000,  // r
0x0000, 0x0000, 0x3800, 0x4400, 0x3000, 0x0800, 0x4400, 0x3800, 0x0000, 0x0000,  // s
0x2000, 0x2000, 0x7800, 0x2000, 0x2000, 0x2000, 0x2000, 0x1800, 0x0000, 0x0000,  // t
0x0000, 0x0000, 0x4400, 0x4400, 0x4400, 0x4400, 0x4C00, 0x3400, 0x0000, 0x0000,  // u
0x0000, 0x0000, 0x4400, 0x4400, 0x2800, 0x2800, 0x2800, 0x1000, 0x0000, 0x0000,  // v
0x0000, 0x0000, 0x5400, 0x5400, 0x5400, 0x6C00, 0x2800, 0x2800, 0x0000, 0x0000,  // w
0x0000, 0x0000, 0x4400, 0x2800, 0x1000, 0x1000, 0x2800, 0x4400, 0x0000, 0x0000,  // x
0x0000, 0x0000, 0x4400, 0x4400, 0x2800, 0x2800, 0x1000, 0x1000, 0x1000, 0x6000,  // y
0x0000, 0x0000, 0x7C00, 0x0800, 0x1000, 0x2000, 0x4000, 0x7C00, 0x0000, 0x0000,  // z
0x1800, 0x1000, 0x1000, 0x1000, 0x2000, 0x2000, 0x1000, 0x1000, 0x1000, 0x1800,  // {
0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000, 0x1000,  // |
0x3000, 0x1000, 0x1000, 0x1000, 0x0800, 0x0800, 0x1000, 0x1000, 0x1000, 0x3000,  // }
0x0000, 0x0000, 0x0000, 0x7400, 0x4C00, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,  // ~
};




FontDef Font_7x10 = {7,10,Font7x10};

#define X_SHIFT 0
#define Y_SHIFT 0


#define ABS(x) ((x) > 0 ? (x) : -(x))
#define WHITE 0xFFFF
#define BLACK 0x0000
#define BLUE 0x001F
#define RED 0xF800
#define MAGENTA 0xF81F
#define GREEN 0x07E0
#define CYAN 0x7FFF
#define YELLOW 0xFFE0
#define GRAY 0X8430
#define BRED 0XF81F
#define GRED 0XFFE0
#define GBLUE 0X07FF
#define BROWN 0XBC40
#define BRRED 0XFC07
#define DARKBLUE 0X01CF
#define LIGHTBLUE 0X7D7C
#define GRAYBLUE 0X5458

#define LIGHTGREEN 0X841F
#define LGRAY 0XC618
#define LGRAYBLUE 0XA651
#define LBBLUE 0X2B12

/* Control Registers and constant codes */
#define ST7789_NOP     0x00
#define ST7789_SWRESET 0x01
#define ST7789_RDDID   0x04
#define ST7789_RDDST   0x09

#define ST7789_SLPIN   0x10
#define ST7789_SLPOUT  0x11
#define ST7789_PTLON   0x12
#define ST7789_NORON   0x13

#define ST7789_INVOFF  0x20
#define ST7789_INVON   0x21
#define ST7789_DISPOFF 0x28
#define ST7789_DISPON  0x29
#define ST7789_CASET   0x2A
#define ST7789_RASET   0x2B
#define ST7789_RAMWR   0x2C
#define ST7789_RAMRD   0x2E

#define ST7789_PTLAR   0x30
#define ST7789_COLMOD  0x3A
#define ST7789_MADCTL  0x36

/** 
 * Memory Data Access Control Register (0x36H)
 * MAP:     D7  D6  D5  D4  D3  D2  D1  D0 
 * param:   MY  MX  MV  ML  RGB MH  -   -
 * 
 */ 

/* Page Address Order ('0': Top to Bottom, '1': the opposite) */
#define ST7789_MADCTL_MY  0x80  
/* Column Address Order ('0': Left to Right, '1': the opposite) */
#define ST7789_MADCTL_MX  0x40  
/* Page/Column Order ('0' = Normal Mode, '1' = Reverse Mode) */
#define ST7789_MADCTL_MV  0x20  
/* Line Address Order ('0' = LCD Refresh Top to Bottom, '1' = the opposite) */
#define ST7789_MADCTL_ML  0x10
/* RGB/BGR Order ('0' = RGB, '1' = BGR) */
#define ST7789_MADCTL_RGB 0x00

#define ST7789_RDID1   0xDA
#define ST7789_RDID2   0xDB
#define ST7789_RDID3   0xDC
#define ST7789_RDID4   0xDD

#define ST7789_COLOR_MODE_16bit 0x55    //  RGB565 (16bit)
#define ST7789_COLOR_MODE_18bit 0x66    //  RGB666 (18bit)


void ST7789_Init(void);
void ST7789_SetRotation(benim m);
void ST7789_Fill_Color(uint16_t color);


void ST7789_Test(void);

void ST7789_WriteCommand(uint8_t cmd);
 void ST7789_WriteSmallData(uint8_t data);




 void ST7789_WriteSmallData(uint8_t data)
{
	
	
	GPIOA->BSRR |=1<<20; //A4 RESET
	
	GPIOA->BSRR |=1<<0; //dc 1 
	//SPI1->CR1 |= 1<<6;
	
	
   SPI1->DR=data;
   while(!(SPI1->SR & 0x0002));
	 while((SPI1->SR & 0x0080));  //BSY =0 olmasini bekle.
	uint32_t temp=0x00U;
	temp=SPI1->DR;
	temp=SPI1->SR;
	GPIOA->BSRR |=1<<4;//A4 SET
	(void)temp;
	
}


void ST7789_SetRotation(uint8_t m)
{
	ST7789_WriteCommand(ST7789_MADCTL);	// MADCTL

	switch (m) {
	case 0:
		ST7789_WriteSmallData(ST7789_MADCTL_MX | ST7789_MADCTL_MY | ST7789_MADCTL_RGB);
		break;
	case 1:
		ST7789_WriteSmallData(ST7789_MADCTL_MY | ST7789_MADCTL_MV | ST7789_MADCTL_RGB);
		break;
	case 2:
		ST7789_WriteSmallData(ST7789_MADCTL_RGB);
		break;
	case 3:
		ST7789_WriteSmallData(ST7789_MADCTL_MX | ST7789_MADCTL_MV | ST7789_MADCTL_RGB);
		break;
	default:
		break;
	}
}


 void ST7789_SetAddressWindow(uint8_t x0, uint8_t y0, uint8_t x1, uint8_t y1)
{
	GPIOA->BSRR |=1<<20;
	uint8_t x_start = x0 + X_SHIFT; 
	uint8_t x_end = x1 + X_SHIFT;
	uint8_t y_start = y0 + Y_SHIFT;
	uint8_t y_end = y1 + Y_SHIFT;
	
	
	ST7789_WriteCommand(ST7789_CASET);
  
	{
		uint8_t data[] = {x_start >> 8, x_start & 0xFF, x_end >> 8, x_end & 0xFF};
		int sayac=0;
		
		for(;sayac<4;sayac++)
		{
		
     ST7789_WriteSmallData(data[sayac]);
		}
		
		
		
		//ST7789_WriteData(data, sizeof(data));
	}

	
	ST7789_WriteCommand(ST7789_RASET);
	
	{
		uint8_t data[] = {y_start >> 8, y_start & 0xFF, y_end >> 8, y_end & 0xFF};
		int sayac=0;
		
		for(;sayac<4;sayac++)
		{
		
     ST7789_WriteSmallData(data[sayac]);
		}
		
		//ST7789_WriteData(data, sizeof(data));
	}
	
	ST7789_WriteCommand(ST7789_RAMWR);
   GPIOA->BSRR |=1<<4;
	
}


void ST7789_Init(void)
{   
	
	   
	 // delay(25); //25 msn
	for(sayi=0;sayi<1000000;sayi++);	
	  
    GPIOA->BSRR |=1<<17; //a1 res
	 // delay(25); //25 msn
    for(sayi=0;sayi<1000000;sayi++);	
    GPIOA->BSRR |=1<<1;
	 // delay(50); //50 ms
	for(sayi=0;sayi<1000000;sayi++);	
    
		
    ST7789_WriteCommand(ST7789_COLMOD);		//	Set color mode
    ST7789_WriteSmallData(ST7789_COLOR_MODE_16bit);
  	ST7789_WriteCommand(0xB2);				//	Porch control
	

		//uint8_t data[] = {0x0C, 0x0C, 0x00, 0x33, 0x33};
		ST7789_WriteSmallData(0x0C);
		ST7789_WriteSmallData(0x0C);
		ST7789_WriteSmallData(0x00);
		ST7789_WriteSmallData(0x33);
		ST7789_WriteSmallData(0x33);
		//delay(500);
		
		//ST7789_WriteData(data, sizeof(data));
	  //ST7789_SetRotation(2);	//	MADCTL (Display Rotation)
		 ST7789_WriteCommand(ST7789_MADCTL);	// MADCTL
		 ST7789_WriteSmallData(ST7789_MADCTL_RGB);
	 
    ST7789_WriteCommand(0xB7);				//	Gate Control
    ST7789_WriteSmallData(0x35);			//	Default value
    ST7789_WriteCommand(0xBB);				//	VCOM setting
    ST7789_WriteSmallData(0x19);			//	0.725v (default 0.75v for 0x20)
    ST7789_WriteCommand(0xC0);				//	LCMCTRL	
    ST7789_WriteSmallData (0x2C);			//	Default value
    ST7789_WriteCommand (0xC2);				//	VDV and VRH command Enable
    ST7789_WriteSmallData (0x01);			//	Default value
    ST7789_WriteCommand (0xC3);				//	VRH set
    ST7789_WriteSmallData (0x12);			//	+-4.45v (defalut +-4.1v for 0x0B)
    ST7789_WriteCommand (0xC4);				//	VDV set
    ST7789_WriteSmallData (0x20);			//	Default value
    ST7789_WriteCommand (0xC6);				//	Frame rate control in normal mode
    ST7789_WriteSmallData (0x0F);			//	Default value (60HZ)
    ST7789_WriteCommand (0xD0);				//	Power control
    ST7789_WriteSmallData (0xA4);			//	Default value
    ST7789_WriteSmallData (0xA1);			//	Default value
	

	ST7789_WriteCommand(0xE0);
	
		uint8_t data1[] = {0xD0, 0x04, 0x0D, 0x11, 0x13, 0x2B, 0x3F, 0x54, 0x4C, 0x18, 0x0D, 0x0B, 0x1F, 0x23};
		int sayac=0;
		for(;sayac<14;sayac++)
		{
		  	ST7789_WriteSmallData(data1[sayac]);
		    
		
		}
		
		
		//ST7789_WriteData(data1, sizeof(data));
	

    ST7789_WriteCommand(0xE1);
	
		uint8_t data2[] = {0xD0, 0x04, 0x0C, 0x11, 0x13, 0x2C, 0x3F, 0x44, 0x51, 0x2F, 0x1F, 0x1F, 0x20, 0x23};
		sayac=0;
			for(;sayac<14;sayac++)
		{
		  	ST7789_WriteSmallData(data2[sayac]);
		    
		
		}
		//ST7789_WriteData(data2, sizeof(data));
	
	
    ST7789_WriteCommand (ST7789_INVON);		//	Inversion ON
	ST7789_WriteCommand (ST7789_SLPOUT);	//	Out of sleep mode
  	ST7789_WriteCommand (ST7789_NORON);		//	Normal Display on
  	ST7789_WriteCommand (ST7789_DISPON);	//	Main screen turned on	

	//delay(50);//50 ms
		
	for(sayi=0;sayi<1000000;sayi++);	
	ST7789_Fill_Color(BLACK);				//	Fill with Black.
	
}


void ST7789_Fill_Color(uint16_t color)
{
	uint8_t i, j;
  ST7789_SetAddressWindow(0, 0, 240 - 1, 240 - 1);
	GPIOA->BSRR |=1<<20;
	
	for (i = 0; i < 240; i++)
		for (j = 0; j < 240; j++) {
		//	uint8_t data[] = {color >> 8, color & 0xFF};
			
			
		  	ST7789_WriteSmallData(color >> 8);
		    
			  ST7789_WriteSmallData(color & 0xFF);
		
		
			//ST7789_WriteData(data, sizeof(data));
		}
 GPIOA->BSRR |=1<<4;
}




void ST7789_Test(void)
{
	ST7789_Fill_Color(WHITE);
	//delay(1000);
	for(sayi=0;sayi<10000000;sayi++);	
	ST7789_Fill_Color(RED);
	
	
}




void ST7789_WriteCommand(uint8_t cmd)  //ST7789_SendCmd
{
  GPIOA->BSRR |=1<<20;
	GPIOA->BSRR |=1<<16;//dc 0
	SPI1->CR1 |=1<<6;
	 
  SPI1->DR=cmd;
  while(!(SPI1->SR & 0x0002)); //TXE =1 olmasini bekle.
	while((SPI1->SR & 0x0080));  //BSY =0 olmasini bekle.
	uint32_t temp=0x00U;
	temp=SPI1->DR;
	temp=SPI1->SR;
	GPIOA->BSRR |=1<<20;
	(void)temp;
	
}

void ST7789_WriteData(uint8_t *gonder,uint16_t size)  //ST7789_SendData
{ 
	
	 GPIOA->BSRR |=1<<0; //dc 1 
	 //SPI1->CR1 |= 1<<6;
	//*((__IO uint8_t *)&SPI1->DR) =*gonder;
	 SPI1->DR=*gonder;
	 gonder++;
	 size--;
	  while(size>0)
  {		
		if((SPI1->SR & 0x0002))
		{
		 SPI1->DR=*gonder;
		size--;
    gonder++;			
		
		}
	  
	}
	while((SPI1->SR & 0x0080));
	
	
	/*
  while(size>0)
  {		
	//GPIOA->ODR |=1<<0;
	GPIOA->BSRR |=1<<0; //dc 1 
	SPI1->CR1 |= 1<<6;
	
	
   SPI1->DR=*data;
   while(!(SPI1->SR & 0x0002));
	 while((SPI1->SR & 0x0010));  //BSY =0 olmasini bekle.
	 size--;
	 data++;	
	}
	*/
	
}

void RCC_Config()
{
	 
	RCC->CR &=~(1<<0);//hsi off yap
	
	RCC->CR |= 0x00010000;	// HSEON
	while(!(RCC->CR & 0x00020000));	// HSEON Ready Flag wait
	
		
	RCC->APB1ENR |=RCC_APB1ENR_PWREN;
	PWR->CR |=PWR_CR_VOS;
	
	//RCC->CR |=(1<<19);//css 

	RCC->PLLCFGR = 0x04402A04; //0040 tu..!!!!!!!!!!!!!!!!!!!!!!!!!
	RCC->CR |= 0x01000000;			// PLL On
	while(!(RCC->CR & (1<<25)));	// /pll bayrak kontolu.
	
	
	RCC->CFGR |= 0x00000000;		// AHB Prescaler 1   
	RCC->CFGR |= 0x00009400;		// APB1 Prescaler 4  APB2 Prescaler 2
	
	
	FLASH->ACR = 0x00000605;  //5 ONEMLI
	RCC->CFGR |= 0x00000002; //Sistem PLL icin
	while(!(RCC->CFGR & (1<<1)));	// /pll bayrak kontolu.
	
		
	
	
}



void spi_init()
{
 
	RCC->AHB1ENR |= 0x00000081; //GPIOA  GPIOH aktif..

	
	GPIOA->BSRR |=1<<16;
	GPIOA->BSRR |=1<<17;
	
	GPIOA->AFR[0]= 0x50500000; //AF5  PA7  PA5 
	GPIOA->MODER |=0x00008905; //PA7  PA5  Alter.Function.
	GPIOA->OSPEEDR |=0x0000CF0F;//Very High Speed.
  GPIOA->OTYPER =0x00000000; //Push-Pull.
	GPIOA->PUPDR =0x00004400;  //Pull Up
	
	RCC->AHB1ENR |= 0x00000008; //GPIOD aktif..
	GPIOD->MODER |=0x55000000;
	GPIOD->OTYPER =0x00000000; 
	
	RCC->APB2ENR |= 0x00005000; //SPI1  aktif.
	SPI1->CR1 &= ~(1<<15); //BIDIMODE biti
	SPI1->CR1 &= ~(1<<14); //BIDIOE biti.
	SPI1->CR1 |= 1<<9;//SSM biti.
	SPI1->CR1 |= 1<<8;//SSI biti.
	SPI1->CR1 |= 1<<2;//Master secimi.
	SPI1->CR1 &= ~(1<<1); //CPOL 0
	SPI1->CR1 &= ~(1<<0); //CPHA  0
	SPI1->CR1 &= ~(1<<3);  // baud rate // f/32
	SPI1->CR1 &= ~(1<<5); //baud rate   //  f/32
	SPI1->CR2  &=~(1<<2);//SSOE biti.
	//SPI1->CR1 |= 1<<6; //SPI aktif.
	
	
	
}

int main()
	
{

RCC_Config();
spi_init();
//SystemCoreClockUpdate();
//SysTick_Config(SystemCoreClock/1000);//1 mslik timer için.
	

	
ST7789_Init();	



while(1)
{
	
	GPIOD->BSRR |=1<<12;
	//delay(1000);
	
	for(sayi=0;sayi<10000000;sayi++);	
	GPIOD->BSRR |=1<<28;
	
	//delay(1000);
	
  
	//ST7789_FillScreen(RED);
  //ST7789_DrawChar_5x8(0, 0, RGB565(0, 255, 255), RGB565(0, 0, 0), 0, 'B');
  //bekle(420000000);
	
	 ST7789_Test();
	
}




}
/*
void spi_init()

{
 rcc-> spi1 en;
 spi pinleri afio olarak ayarla;
 
sp11->cr1 biomode 1 line bidirec;
spi1->cr  bidioe;
spi1->cr  ssm;

baud rate ayarla.
master olarak spi sec;
cpol ve cpha ayrla.

spi1->cr2 ssoe 1 ;


spi1->cr  en;

}



void spi_send(uint8 data)
{

 SPI->DR=data;
 while((SPI->SR & SPI_SR_TXE !=1);
}
*/

